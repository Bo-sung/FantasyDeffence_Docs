# 생산 시스템

[← 영지 시스템](../영지%20시스템.md)

---

## 핵심 루프

```
   ┌──────────┐
   │  건물 배치 │ ◄── 은화 소모
   └─────┬────┘
         │
         ▼
   ┌──────────┐
   │ 시간 경과  │ ◄── 생산 시설: 자원 축적
   │          │ ◄── 주거 시설: 세금 축적
   └─────┬────┘
         │
         ▼
   ┌──────────┐
   │  자원 수확  │ ──► 식량, 마석, 보급, 인력, 은화 획득
   └─────┬────┘
         │
         ▼
   ┌──────────┐
   │ 건물 레벨업 │ ◄── 은화 소모, 생산량 증가
   └─────┬────┘
         │
         ▼
   ┌──────────────┐
   │ 편의 시설 건설  │ ◄── 만족도 상승 → 전체 생산 보너스
   └──────┬───────┘
          │
          ▼
   ┌──────────┐
   │ 구역 확장  │ ◄── 은화 소모, 새 타일 확보
   └──────────┘
          │
          └───► (더 많은 건물 배치 → 루프 반복)
```

---

## 생산 공식

```
실제 생산량(시간당) = 기본 생산량 × 만족도 × 구역 보너스
```

- **만족도**: [만족도 시스템](만족도%20시스템.md) 참조
- **구역 보너스**: [맵·구역 시스템](맵·구역%20시스템.md) 참조

---

## 생산 시설 레벨별 수치

### 농장 (식량)

| 레벨 | 시간당 생산 | 최대 저장량 | 업그레이드 비용 |
|------|-------------|-------------|-----------------|
| 1 | 60 | 500 | - |
| 2 | 90 | 750 | 은화 1,000 |
| 3 | 130 | 1,000 | 은화 2,500 |
| 4 | 180 | 1,500 | 은화 5,000 |
| 5 | 250 | 2,000 | 은화 10,000 |

### 마력 정제소 (마석)

| 레벨 | 시간당 생산 | 최대 저장량 | 업그레이드 비용 |
|------|-------------|-------------|-----------------|
| 1 | 30 | 300 | - |
| 2 | 45 | 450 | 은화 1,500 |
| 3 | 65 | 600 | 은화 3,500 |
| 4 | 90 | 900 | 은화 7,000 |
| 5 | 120 | 1,200 | 은화 15,000 |

### 보급창고 (보급)

| 레벨 | 시간당 생산 | 최대 저장량 | 업그레이드 비용 |
|------|-------------|-------------|-----------------|
| 1 | 40 | 400 | - |
| 2 | 60 | 600 | 은화 1,200 |
| 3 | 85 | 800 | 은화 3,000 |
| 4 | 115 | 1,200 | 은화 6,000 |
| 5 | 160 | 1,600 | 은화 12,000 |

### 훈련소 (인력)

| 레벨 | 시간당 생산 | 최대 저장량 | 업그레이드 비용 |
|------|-------------|-------------|-----------------|
| 1 | 20 | 200 | - |
| 2 | 30 | 300 | 은화 2,000 |
| 3 | 45 | 450 | 은화 5,000 |
| 4 | 65 | 600 | 은화 10,000 |
| 5 | 90 | 800 | 은화 20,000 |

---

## 수확 규칙

- **개별 수확**: 생산 건물 클릭 → 저장된 자원 획득
- **전체 수확**: 전체 수확 버튼 → 모든 생산물 + 세금 일괄 획득
- **저장량 초과 시**: 생산 정지 (넘치면 대기, 손실 없음)

---

## 전투 자원 연결

| 생산 시설 | 자원 | 전투 용도 |
|-----------|------|-----------|
| 농장 | 식량 | 출격 부대 유지 (링크 비례) |
| 마력 정제소 | 마석 | 마법 포대 출격 |
| 보급창고 | 보급 | 물리 포탑 출격, 소모품 재료 |
| 훈련소 | 인력 | 링크 확장/수리 |

---

## 생산 관련 함수

### 생산량 계산

```csharp
public float GetProductionRate(BuildingInstance building)
{
    var config = ConfigBuilding.Get(building.BuildingId);
    var levelData = config.Levels[building.Level];
    float satisfaction = CalculateSatisfaction();

    // 구역 보너스
    var zone = ConfigZone.Get(building.ZoneId);
    float zoneBonus = (zone.BonusBuilding == building.BuildingId)
        ? zone.BonusRate : 1.0f;

    return levelData.ProductionPerHour * satisfaction * zoneBonus;
}
```

### 생산 업데이트 (매 틱)

```csharp
public void UpdateProduction(float deltaSeconds)
{
    foreach (var building in _gameState.Buildings)
    {
        var config = ConfigBuilding.Get(building.BuildingId);
        if (config.Category != BuildingCategory.PRODUCTION) continue;

        var levelData = config.Levels[building.Level];
        float rate = GetProductionRate(building);
        float produced = (rate / 3600f) * deltaSeconds;

        building.StoredAmount = Mathf.Min(
            building.StoredAmount + produced,
            levelData.MaxStorage
        );
    }

    // 세금 누적
    UpdateTax(deltaSeconds);
}
```

### 수확

```csharp
public void HarvestBuilding(int buildingInstanceId)
{
    var building = _gameState.Buildings.Find(b => b.Id == buildingInstanceId);
    var config = ConfigBuilding.Get(building.BuildingId);

    if (config.Category == BuildingCategory.PRODUCTION)
    {
        int amount = Mathf.FloorToInt(building.StoredAmount);
        _gameState.AddResource(config.ResourceType, amount);
        building.StoredAmount = 0f;
        building.LastHarvestTime = DateTime.Now;
    }
}

public void HarvestAll()
{
    foreach (var building in _gameState.Buildings)
    {
        HarvestBuilding(building.Id);
    }
    HarvestTax();
}
```

---
tags: [plan, client, server]
---

# 건설 시스템

[← 영지 시스템](../영지%20시스템.md)

---

## 컨셉

- **유사 하우징 시스템**: 서브컬처 게임의 카페/기지처럼 내 공간 꾸미기
- **자유 배치**: 격자 기반 타일맵에 건물 자유 배치
- **영웅 생활**: 배치된 영웅이 영지 내 돌아다님

---

## 건설 프로세스

```
1. 하단 메뉴에서 건물 선택
2. 맵 위에서 마우스/터치 이동 → 배치 미리보기 (초록/빨강)
3. 회전 조절 (0°, 90°, 180°, 270°)
4. 클릭/터치 → 배치 확정
5. 은화 차감, 건물 즉시 생성 (대기 시간 없음)
```

---

## 배치 시스템

| 기능 | 설명 |
|------|------|
| 드래그 앤 드롭 | 건물을 원하는 위치에 배치 |
| 건물 회전 | 배치 시 방향 조절 (0°, 90°, 180°, 270°) |
| 도로 | 장식용 (기능 없음, 데코) |
| 충돌 검사 | 건물 겹침 불가 |

### 제외 요소 (단순화)

- 인접 보너스 없음 (농장끼리 붙여도 효율 동일)
- 도로 연결 시스템 없음

---

## 충돌 검사

```
배치 가능 조건:
  ✓ 대상 타일이 모두 비어있음 (mapData[y][x] === 0)
  ✓ 맵 범위 내 (성벽 안쪽)
  ✓ 해당 건물의 최대 개수 미초과
  ✓ 은화 충분
  ✓ 해금 조건 충족

배치 불가:
  ✗ 다른 건물과 겹침
  ✗ 성벽/영주성 위
  ✗ 잠긴 구역
  ✗ 자원 부족
  ✗ 해금 조건 미충족
```

---

## 철거

- 건물 클릭 → 철거 버튼 → 비용 50% 환급
- 장식 시설은 100% 환급
- 즉시 철거 (대기 시간 없음)
- 타일 즉시 해제

---

## 배치 검증 (서버)

### 검증 항목

| 항목 | 설명 |
|------|------|
| 좌표 범위 | 0 ≤ x, y < 현재 맵 크기 |
| 충돌 검사 | 다른 건물과 겹침 불가 |
| 고정 영역 | 영주성, 성벽 위치 배치 불가 |
| 건설 조건 | 해금 조건 충족 여부 |
| 최대 개수 | 건물별 최대 개수 초과 불가 |
| 회전 값 | 0, 90, 180, 270만 허용 |

### 에러 코드

| 코드 | 설명 |
|------|------|
| E001 | 좌표 범위 초과 |
| E002 | 건물 충돌 |
| E003 | 고정 영역 침범 |
| E004 | 해금 조건 미충족 |
| E005 | 최대 개수 초과 |
| E006 | 잘못된 회전 값 |
| E007 | 자원 부족 |

---

## 건설 관련 함수

### 건설

```csharp
public ErrorCode PlaceBuilding(string buildingId, int x, int y, Rotation rotation)
{
    var config = ConfigBuilding.Get(buildingId);

    // 검증
    if (_gameState.Silver < config.BuildCost) return ErrorCode.INSUFFICIENT_RESOURCE;
    if (!CanPlace(x, y, config.SizeX, config.SizeY)) return ErrorCode.COLLISION;
    if (CountBuilding(buildingId) >= config.MaxCount) return ErrorCode.MAX_COUNT;
    if (_gameState.CastleLevel < config.UnlockCastleLevel) return ErrorCode.NOT_UNLOCKED;

    // 배치
    _gameState.Silver -= config.BuildCost;
    var instance = new BuildingInstance
    {
        Id = _nextId++,
        BuildingId = buildingId,
        X = x, Y = y,
        Rotation = rotation,
        Level = 1,
        StoredAmount = 0f,
        LastHarvestTime = DateTime.Now,
    };
    _gameState.Buildings.Add(instance);
    MarkMap(x, y, config.SizeX, config.SizeY, occupied: true);

    return ErrorCode.NONE;
}
```

### 레벨업

```csharp
public ErrorCode UpgradeBuilding(int buildingInstanceId)
{
    var building = _gameState.Buildings.Find(b => b.Id == buildingInstanceId);
    var config = ConfigBuilding.Get(building.BuildingId);
    int nextLevel = building.Level + 1;

    if (!config.Levels.ContainsKey(nextLevel)) return ErrorCode.MAX_LEVEL;

    int cost = config.Levels[nextLevel].UpgradeCost;
    if (_gameState.Silver < cost) return ErrorCode.INSUFFICIENT_RESOURCE;

    _gameState.Silver -= cost;
    building.Level = nextLevel;
    return ErrorCode.NONE;
}
```

### 철거

```csharp
public int DemolishBuilding(int buildingInstanceId)
{
    var building = _gameState.Buildings.Find(b => b.Id == buildingInstanceId);
    var config = ConfigBuilding.Get(building.BuildingId);

    // 환급
    int refund = Mathf.FloorToInt(config.BuildCost * config.DemolishRefundRate);
    _gameState.Silver += refund;

    // 맵 해제
    MarkMap(building.X, building.Y, config.SizeX, config.SizeY, occupied: false);

    // 제거
    _gameState.Buildings.Remove(building);
    return refund;
}
```

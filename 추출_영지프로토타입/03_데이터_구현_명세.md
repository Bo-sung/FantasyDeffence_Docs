# 데이터 & 구현 명세

[← README](README.md)

---

## 1. 데이터 구조

### 1.1 Config 데이터 (JSON)

프로토타입은 서버 없이 클라이언트 내 JSON 객체로 Config를 관리한다.

#### 건물 마스터

```javascript
const CONFIG_BUILDING = {
  B001: {
    name: "농장", category: "production", resource: "food",
    sizeX: 2, sizeY: 2, buildCost: 500, maxCount: 4,
    unlockCastleLevel: 1, demolishRefund: 0.5,
    levels: {
      1: { upgradeCost: 0,    productionPerHour: 60,  maxStorage: 500  },
      2: { upgradeCost: 1000, productionPerHour: 90,  maxStorage: 750  },
      3: { upgradeCost: 2500, productionPerHour: 130, maxStorage: 1000 },
    }
  },
  B002: {
    name: "마력 정제소", category: "production", resource: "mana",
    sizeX: 2, sizeY: 2, buildCost: 1000, maxCount: 3,
    unlockCastleLevel: 2, demolishRefund: 0.5,
    levels: {
      1: { upgradeCost: 0,    productionPerHour: 30, maxStorage: 300 },
      2: { upgradeCost: 1500, productionPerHour: 45, maxStorage: 450 },
      3: { upgradeCost: 3500, productionPerHour: 65, maxStorage: 600 },
    }
  },
  B011: {
    name: "민가", category: "housing",
    sizeX: 1, sizeY: 1, buildCost: 100, maxCount: 10,
    unlockCastleLevel: 1, demolishRefund: 0.5,
    levels: {
      1: { upgradeCost: 0,   population: 2 },
      2: { upgradeCost: 500, population: 3 },
      3: { upgradeCost: 1200, population: 4 },
    }
  },
  B012: {
    name: "연립 주택", category: "housing",
    sizeX: 1, sizeY: 2, buildCost: 300, maxCount: 6,
    unlockCastleLevel: 2, demolishRefund: 0.5,
    levels: {
      1: { upgradeCost: 0,   population: 6 },
      2: { upgradeCost: 800, population: 9 },
      3: { upgradeCost: 2000, population: 12 },
    }
  },
  B021: {
    name: "우물", category: "comfort",
    sizeX: 1, sizeY: 1, buildCost: 50, maxCount: 6,
    unlockCastleLevel: 1, demolishRefund: 0.5,
    levels: {
      1: { upgradeCost: 0,   comfortBonus: 0.05 },
      2: { upgradeCost: 300, comfortBonus: 0.07 },
      3: { upgradeCost: 800, comfortBonus: 0.10 },
    }
  },
  B022: {
    name: "방앗간", category: "comfort",
    sizeX: 2, sizeY: 2, buildCost: 400, maxCount: 3,
    unlockCastleLevel: 3, demolishRefund: 0.5,
    levels: {
      1: { upgradeCost: 0, comfortBonus: 0.10 },
    }
  },
};
```

#### 영주성 레벨

```javascript
const CONFIG_CASTLE = {
  1: { taxCoefficient: 1.0,  upgradeCost: 0,     unlockBuildings: ["B001","B011","B021"] },
  2: { taxCoefficient: 1.05, upgradeCost: 1000,  unlockBuildings: ["B002","B012"] },
  3: { taxCoefficient: 1.1,  upgradeCost: 3000,  unlockBuildings: ["B022"], unlockZones: ["plains"] },
  4: { taxCoefficient: 1.15, upgradeCost: 6000,  unlockBuildings: [] },
  5: { taxCoefficient: 1.2,  upgradeCost: 10000, unlockBuildings: [] },
};
```

#### 구역

```javascript
const CONFIG_ZONE = {
  start: {
    name: "시작 영역", distance: 0, unlockCastleLevel: 1,
    unlockCost: 0, bonusBuilding: null, bonusRate: 1.0,
  },
  plains: {
    name: "평원", distance: 1, unlockCastleLevel: 3,
    unlockCost: 3000, bonusBuilding: "B001", bonusRate: 1.1,
  },
};
```

#### 글로벌 설정

```javascript
const CONFIG_GLOBAL = {
  mapSizeX: 20,
  mapSizeY: 20,
  baseSatisfaction: 0.5,
  maxSatisfaction: 1.5,
  castleSizeX: 4,
  castleSizeY: 4,
  initialSilver: 5000,
};
```

### 1.2 런타임 상태 (Game State)

```javascript
const gameState = {
  // 재화
  silver: 5000,
  food: 0,
  mana: 0,

  // 영주성
  castleLevel: 1,
  accumulatedTax: 0,
  lastTaxCalcTime: Date.now(),

  // 구역 해금
  unlockedZones: ["start"],

  // 배치된 건물 목록
  buildings: [
    // {
    //   id: 1,                 // 인스턴스 고유 ID
    //   buildingId: "B001",    // Config 참조 키
    //   x: 5, y: 7,           // 좌표
    //   level: 1,              // 현재 레벨
    //   storedAmount: 0,       // 현재 저장량 (생산 시설만)
    //   lastHarvestTime: Date.now(),  // 마지막 수확 시각
    //   zoneId: "start",       // 소속 구역
    // }
  ],

  // 맵 데이터 (2D 배열)
  mapData: [], // 초기화 시 생성

  // 시간 가속 배율
  timeScale: 1,
};
```

---

## 2. 핵심 함수 명세

### 2.1 만족도 계산

```javascript
function calculateSatisfaction() {
  let bonus = 0;
  for (const b of gameState.buildings) {
    const config = CONFIG_BUILDING[b.buildingId];
    if (config.category === "comfort") {
      const levelData = config.levels[b.level];
      bonus += levelData.comfortBonus;
    }
  }
  return Math.min(
    CONFIG_GLOBAL.baseSatisfaction + bonus,
    CONFIG_GLOBAL.maxSatisfaction
  );
}
```

### 2.2 생산량 계산

```javascript
function getProductionRate(building) {
  const config = CONFIG_BUILDING[building.buildingId];
  const levelData = config.levels[building.level];
  const satisfaction = calculateSatisfaction();

  // 구역 보너스
  const zone = CONFIG_ZONE[building.zoneId];
  const zoneBonus = (zone.bonusBuilding === building.buildingId)
    ? zone.bonusRate : 1.0;

  return levelData.productionPerHour * satisfaction * zoneBonus;
}
```

### 2.3 생산 업데이트 (매 프레임/틱)

```javascript
function updateProduction(deltaSeconds) {
  const scaledDelta = deltaSeconds * gameState.timeScale;

  for (const b of gameState.buildings) {
    const config = CONFIG_BUILDING[b.buildingId];
    if (config.category !== "production") continue;

    const levelData = config.levels[b.level];
    const rate = getProductionRate(b);
    const produced = (rate / 3600) * scaledDelta;

    b.storedAmount = Math.min(
      b.storedAmount + produced,
      levelData.maxStorage
    );
  }

  // 세금 누적
  updateTax(scaledDelta);
}
```

### 2.4 세금 계산

```javascript
function updateTax(scaledDelta) {
  const satisfaction = calculateSatisfaction();
  const taxCoeff = CONFIG_CASTLE[gameState.castleLevel].taxCoefficient;

  let totalPopulation = 0;
  for (const b of gameState.buildings) {
    const config = CONFIG_BUILDING[b.buildingId];
    if (config.category === "housing") {
      totalPopulation += config.levels[b.level].population;
    }
  }

  const taxPerHour = taxCoeff * totalPopulation * satisfaction;
  const taxEarned = (taxPerHour / 3600) * scaledDelta;
  gameState.accumulatedTax += taxEarned;
}
```

### 2.5 수확

```javascript
function harvestBuilding(buildingInstanceId) {
  const b = gameState.buildings.find(x => x.id === buildingInstanceId);
  const config = CONFIG_BUILDING[b.buildingId];

  if (config.category === "production") {
    const resource = config.resource; // "food" or "mana"
    gameState[resource] += Math.floor(b.storedAmount);
    b.storedAmount = 0;
    b.lastHarvestTime = Date.now();
  }
}

function harvestTax() {
  gameState.silver += Math.floor(gameState.accumulatedTax);
  gameState.accumulatedTax = 0;
}

function harvestAll() {
  for (const b of gameState.buildings) {
    harvestBuilding(b.id);
  }
  harvestTax();
}
```

### 2.6 건설

```javascript
function placeBuilding(buildingId, x, y) {
  const config = CONFIG_BUILDING[buildingId];

  // 검증
  if (gameState.silver < config.buildCost) return { error: "자원 부족" };
  if (!canPlace(x, y, config.sizeX, config.sizeY)) return { error: "배치 불가" };
  if (countBuilding(buildingId) >= config.maxCount) return { error: "최대 개수 초과" };
  if (gameState.castleLevel < config.unlockCastleLevel) return { error: "해금 필요" };

  // 배치
  gameState.silver -= config.buildCost;
  const instance = {
    id: nextId++,
    buildingId, x, y,
    level: 1,
    storedAmount: 0,
    lastHarvestTime: Date.now(),
    zoneId: getZoneAt(x, y),
  };
  gameState.buildings.push(instance);
  markMap(x, y, config.sizeX, config.sizeY, 1);

  return { success: true, building: instance };
}
```

### 2.7 레벨업

```javascript
function upgradeBuilding(buildingInstanceId) {
  const b = gameState.buildings.find(x => x.id === buildingInstanceId);
  const config = CONFIG_BUILDING[b.buildingId];
  const nextLevel = b.level + 1;

  if (!config.levels[nextLevel]) return { error: "최대 레벨" };

  const cost = config.levels[nextLevel].upgradeCost;
  if (gameState.silver < cost) return { error: "자원 부족" };

  gameState.silver -= cost;
  b.level = nextLevel;
  return { success: true };
}
```

### 2.8 철거

```javascript
function demolishBuilding(buildingInstanceId) {
  const idx = gameState.buildings.findIndex(x => x.id === buildingInstanceId);
  const b = gameState.buildings[idx];
  const config = CONFIG_BUILDING[b.buildingId];

  // 환급
  const refund = Math.floor(config.buildCost * config.demolishRefund);
  gameState.silver += refund;

  // 맵 해제
  markMap(b.x, b.y, config.sizeX, config.sizeY, 0);

  // 제거
  gameState.buildings.splice(idx, 1);
  return { refund };
}
```

---

## 3. 구현 체크리스트

### Phase 1: 기본 배치 (핵심)

- [ ] 20×20 격자 맵 렌더링 (CSS Grid 또는 Canvas)
- [ ] 성벽 (외곽 1타일) 렌더링
- [ ] 영주성 (4×4, 중앙) 렌더링
- [ ] 맵 데이터 (2D 배열) 초기화
- [ ] 건설 메뉴 UI (6종 건물 버튼)
- [ ] 건물 선택 → 마우스 따라 미리보기
- [ ] 충돌 검사 (초록/빨강 미리보기)
- [ ] 클릭 시 건물 배치 + 은화 차감
- [ ] 배치된 건물 렌더링

### Phase 2: 생산 & 수확

- [ ] 시간 경과에 따른 자원 자동 축적
- [ ] 상단 자원바 UI (은화, 식량, 마석)
- [ ] 건물 클릭 → 정보 패널 (저장량, 레벨 등)
- [ ] 개별 수확 기능
- [ ] 전체 수확 버튼
- [ ] 시간 가속 UI 및 로직 (×1, ×10, ×60, ×600)
- [ ] 만족도 표시 UI

### Phase 3: 만족도 & 세금

- [ ] 만족도 계산 로직
- [ ] 만족도 → 생산량 반영
- [ ] 세금 계산 (인구 × 세금계수 × 만족도)
- [ ] 세금 누적 → 영주성 클릭 시 수령
- [ ] 인구수 표시 UI

### Phase 4: 레벨업 & 확장

- [ ] 건물 레벨업 (Lv.1→2→3)
- [ ] 영주성 레벨업 (Lv.1→5)
- [ ] 레벨업 시 건물 해금 반영
- [ ] 구역 확장 (평원)
- [ ] 확장 시 추가 타일 해금
- [ ] 평원 구역 농장 보너스 +10%

### Phase 5: 철거 & 폴리시

- [ ] 철거 기능 (50% 환급)
- [ ] 건물 최대 개수 제한 표시
- [ ] 자원 부족 시 비활성화 표시
- [ ] 건물 툴팁 (hover 정보)
- [ ] 만족도 변화 피드백 (편의 시설 건설/철거 시)

---

## 4. 밸런스 시뮬레이션

### 4.1 초기 진행 시나리오

```
시작 상태: 은화 5,000 / 식량 0 / 마석 0 / 영주성 Lv.1

[1] 농장 건설 (500) → 은화 4,500
[2] 민가 3개 건설 (300) → 은화 4,200
[3] 우물 2개 건설 (100) → 은화 4,100

    만족도 = 50% + 10% = 60%
    식량 생산 = 60 × 0.6 = 36/h
    세금 = 1.0 × 6 × 0.6 = 3.6 은화/h

[4] 농장 1개 추가 (500) → 은화 3,600
    식량 생산 = 72/h (36 × 2)

[5] 민가 2개 추가 (200) → 은화 3,400
    세금 = 1.0 × 10 × 0.6 = 6.0 은화/h

[6] 영주성 Lv.2 (1,000) → 은화 2,400
    마력 정제소, 연립 주택 해금!
    세금 계수 1.0 → 1.05

[7] 연립 주택 1개 (300) → 은화 2,100
    세금 = 1.05 × 16 × 0.6 = 10.08 은화/h

[8] 마력 정제소 1개 (1,000) → 은화 1,100
    마석 생산 = 30 × 0.6 = 18/h

[9] 영주성 Lv.3 (3,000) → 은화 부족! 세금 대기 필요
    3,000 - 1,100 = 1,900 은화 필요
    10.08 은화/h → 약 188시간... (실시간 기준)
    ×600 가속 시 약 19분
```

### 4.2 밸런스 조정 포인트

| 항목 | 조정 가능 변수 | 영향 |
|------|----------------|------|
| 초기 은화 | `initialSilver` | 초기 건설 자유도 |
| 세금 계수 | `taxCoefficient` | 은화 수입 속도 |
| 건설 비용 | `buildCost` | 건물 배치 빈도 |
| 기본 만족도 | `baseSatisfaction` | 편의 시설 필요성 |
| 생산량 | `productionPerHour` | 수확 빈도 체감 |

---

## 5. 원본 → 프로토 변경 사항 요약

| 항목 | 원본 | 프로토타입 | 사유 |
|------|------|-----------|------|
| 맵 크기 | 30×30 | 20×20 | 공간 압박 빠르게 체감 |
| 건물 종류 | 20종+ | 6종 | 핵심 루프만 검증 |
| 건물 최대 레벨 | Lv.5 | Lv.3 | 진행 속도 단축 |
| 영주성 만렙 | Lv.50 | Lv.5 | 전체 루프 빠르게 경험 |
| 구역 | 7구역 | 2구역 (시작+평원) | 최소 확장 경험 |
| 구역 확장 조건 | Lv.10+ | Lv.3 | 빠른 경험 |
| 건물 회전 | 0/90/180/270 | 없음 (0도 고정) | 복잡도 감소 |
| 영웅 배치 | 있음 | 없음 | 영웅 시스템 의존 |
| 전투 자원 소모 | 있음 | 없음 | 전투 시스템 의존 |
| 오프라인 생산 | 있음 | 없음 | 프로토 불필요 |
| 서버 검증 | 있음 | 없음 | 클라이언트 단독 |
| 시간 가속 | 없음 | ×1~×600 | 프로토 검증 편의 |

# 핵심 시스템 설계

[← README](README.md)

---

## 1. 맵 시스템

### 1.1 격자 스펙

| 항목 | 프로토타입 값 | 원본 |
|------|--------------|------|
| 전체 맵 | **20 × 20** 타일 | 30 × 30 |
| 타일 크기 | 40px × 40px (렌더링) | - |
| 성벽 | 외곽 1타일 | 동일 |
| 영주성 | 중앙 4 × 4, 고정 | 동일 |
| 유효 배치 영역 | 18 × 18 (성벽 제외) | - |

> 프로토타입에서는 30×30 대신 20×20으로 축소하여 공간 압박을 빠르게 체감하도록 한다.

### 1.2 구역 시스템 (단순화)

프로토타입에서는 **2개 구역만** 사용:

```
┌────────────────────┐
│                    │
│   ★ 영주성 ★       │ 시작 영역 (기본 해금)
│   (시작 영역)       │ 유효 타일: ~약 310칸
│                    │ (18×18 - 영주성 16칸 = 308칸)
│                    │
└────────┬───────────┘
         │ 확장 (은화 5,000)
┌────────┴───────────┐
│       평원          │ 거리 1 (영주성 Lv.10)
│                    │ 추가 타일: 약 80칸
│  농장 보너스 +10%   │
└────────────────────┘
```

### 구역 확장 조건

| 구역 | 해금 조건 | 비용 | 보너스 |
|------|-----------|------|--------|
| 시작 영역 | 기본 | - | 없음 |
| 평원 | 영주성 Lv.3 (프로토 기준 완화) | 은화 3,000 | 농장 생산 +10% |

> 원본의 Lv.10 조건은 프로토에서 Lv.3으로 완화하여 빠르게 확장을 경험하도록 한다.

### 1.3 맵 데이터 구조

```javascript
// 2D 배열: 0=빈땅, 1=점유
mapData[y][x] = 0 | 1

// 구역 정보
zones = {
  "start": { unlocked: true, tiles: [...] },
  "plains": { unlocked: false, tiles: [...], cost: 3000, requiredCastleLevel: 3 }
}
```

---

## 2. 건설 시스템

### 2.1 프로토타입 건물 목록

**생산 시설 (2종)**

| ID | 시설 | 크기 | 최대 개수 | 건설 비용 | 생산 자원 |
|----|------|------|-----------|-----------|-----------|
| B001 | 농장 | 2×2 | 4 | 은화 500 | 식량 |
| B002 | 마력 정제소 | 2×2 | 3 | 은화 1,000 | 마석 |

**주거 시설 (2종)**

| ID | 시설 | 크기 | 최대 개수 | 건설 비용 | 인구 (Lv.1) |
|----|------|------|-----------|-----------|-------------|
| B011 | 민가 | 1×1 | 10 | 은화 100 | 2명 |
| B012 | 연립 주택 | 1×2 | 6 | 은화 300 | 6명 |

**편의 시설 (2종)**

| ID | 시설 | 크기 | 최대 개수 | 건설 비용 | 만족도 |
|----|------|------|-----------|-----------|--------|
| B021 | 우물 | 1×1 | 6 | 은화 50 | +5% |
| B022 | 방앗간 | 2×2 | 3 | 은화 400 | +10% |

**총 6종의 건물**로 핵심 상호작용을 검증한다.

### 2.2 건설 플로우

```
1. 하단 메뉴에서 건물 선택
2. 맵 위에서 마우스 이동 → 배치 미리보기 (초록/빨강)
3. 클릭 → 배치 확정
4. 은화 차감, 건물 즉시 생성
```

### 2.3 충돌 검사

```
배치 가능 조건:
  ✓ 대상 타일이 모두 mapData[y][x] === 0
  ✓ 맵 범위 내 (성벽 안쪽)
  ✓ 해당 건물의 최대 개수 미초과
  ✓ 은화 충분

배치 불가:
  ✗ 다른 건물과 겹침
  ✗ 성벽/영주성 위
  ✗ 잠긴 구역
  ✗ 자원 부족
```

### 2.4 철거

- 건물 클릭 → 철거 버튼 → 비용 50% 환급
- 즉시 철거, 타일 해제

---

## 3. 생산 시스템

### 3.1 생산 공식

```
실제 생산량(시간당) = 기본 생산량 × 만족도 × 구역 보너스
```

### 3.2 농장 레벨별 수치 (프로토 Lv.1~3)

| 레벨 | 시간당 생산 | 최대 저장량 | 업그레이드 비용 |
|------|-------------|-------------|-----------------|
| 1 | 60 식량 | 500 | - |
| 2 | 90 식량 | 750 | 은화 1,000 |
| 3 | 130 식량 | 1,000 | 은화 2,500 |

### 3.3 마력 정제소 레벨별 수치 (프로토 Lv.1~3)

| 레벨 | 시간당 생산 | 최대 저장량 | 업그레이드 비용 |
|------|-------------|-------------|-----------------|
| 1 | 30 마석 | 300 | - |
| 2 | 45 마석 | 450 | 은화 1,500 |
| 3 | 65 마석 | 600 | 은화 3,500 |

### 3.4 시간 가속 (프로토 전용)

프로토타입에서는 실시간 대기가 비효율적이므로 **시간 가속 기능**을 제공한다.

| 버튼 | 배속 |
|------|------|
| ×1 | 실시간 (1초 = 1초) |
| ×10 | 1초 = 10초 |
| ×60 | 1초 = 1분 |
| ×600 | 1초 = 10분 |

### 3.5 수확

```
수확 방식:
  - 개별 수확: 생산 건물 클릭 → 저장된 자원 획득
  - 전체 수확: 전체 수확 버튼 → 모든 생산물 + 세금 일괄 획득
  - 저장량 초과 시: 생산 정지 (넘치면 대기, 손실 없음)
```

---

## 4. 만족도 시스템

### 4.1 만족도 계산

```
만족도 = 기본(50%) + Σ(편의 시설 보너스)
범위: 50% ~ 150%
```

### 4.2 편의 시설 보너스

| 시설 | Lv.1 | Lv.2 | Lv.3 |
|------|------|------|------|
| 우물 | +5% | +7% | +10% |
| 방앗간 | +10% | - | - |

> 프로토에서 방앗간은 레벨업 없이 고정 +10%.

### 4.3 만족도 영향

만족도는 **모든 생산**에 곱연산으로 적용된다:

- 생산 시설 산출량 × 만족도
- 세금 산출량 × 만족도

### 4.4 예시

```
편의 시설: 우물 2개(+10%) + 방앗간 1개(+10%)
만족도 = 50% + 10% + 10% = 70%

농장 Lv.1 기본 생산: 60/시간
실제 생산: 60 × 0.7 = 42/시간

→ 우물 4개 + 방앗간 2개 추가하면?
만족도 = 50% + 20% + 20% = 90%
실제 생산: 60 × 0.9 = 54/시간 (+28.6% 증가)
```

---

## 5. 세금 시스템

### 5.1 세금 공식

```
시간당 세금(은화) = 세금 계수 × 총 인구수 × 만족도
```

### 5.2 영주성 레벨별 세금 계수 (프로토 Lv.1~5)

| 영주성 레벨 | 세금 계수 |
|-------------|-----------|
| 1 | 1.0 |
| 2 | 1.05 |
| 3 | 1.1 |
| 4 | 1.15 |
| 5 | 1.2 |

### 5.3 영주성 레벨업

| 레벨 | 비용 | 해금 내용 |
|------|------|-----------|
| 1 | - | 농장, 민가, 우물 (기본) |
| 2 | 은화 1,000 | 마력 정제소, 연립 주택 |
| 3 | 은화 3,000 | 방앗간, 구역 확장(평원) 가능 |
| 4 | 은화 6,000 | 농장 최대 4개, 우물 최대 6개 |
| 5 | 은화 10,000 | 마력 정제소 최대 3개 |

> 프로토에서는 영주성 만렙을 5로 축소하여 빠르게 전체 루프를 경험하도록 한다.

### 5.4 인구수 (주거 시설)

| 시설 | Lv.1 | Lv.2 | Lv.3 |
|------|------|------|------|
| 민가 | 2명 | 3명 | 4명 |
| 연립 주택 | 6명 | 9명 | 12명 |

### 5.5 세금 예시

```
영주성 Lv.2 (계수 1.05)
민가 3개 Lv.1 (인구 6) + 연립 1개 Lv.1 (인구 6) = 총 인구 12
만족도 70%

시간당 세금 = 1.05 × 12 × 0.7 = 8.82 은화
```

### 5.6 수령

- 영주성 클릭 → 누적 세금 수령
- 전체 수확 버튼으로도 수령 가능

---

## 6. 재화 시스템 (프로토타입 축소)

### 6.1 사용할 재화

| 재화 | 용도 | 초기 보유량 |
|------|------|-------------|
| 은화 | 건설, 업그레이드, 구역 확장 | 5,000 |
| 식량 | (생산만, 소모처 없음) | 0 |
| 마석 | (생산만, 소모처 없음) | 0 |

> 프로토에서 식량/마석은 **생산-수확 루프 검증 용도**로만 존재한다. 실제 소모는 전투 시스템 연동 후 추가.

### 6.2 은화 순환

```
수입:
  - 세금 (주거 시설 × 만족도)
  - 초기 지급 5,000

지출:
  - 건물 건설 (50~1,000)
  - 건물 업그레이드 (1,000~3,500)
  - 영주성 레벨업 (1,000~10,000)
  - 구역 확장 (3,000)

환급:
  - 철거 시 50% 환급
```

---

## 7. UI 구성

### 7.1 화면 레이아웃

```
┌──────────────────────────────────────────┐
│ [🌾 식량: 0] [💎 마석: 0] [🪙 은화: 5000] │ ← 상단 자원바
│ [만족도: 50%]  [×1] [×10] [×60] [×600]   │ ← 만족도 + 시간 가속
├──────────────────────────────────────────┤
│                                          │
│              20×20 격자 맵               │
│                                          │
│           ┌────────┐                     │
│           │ 영주성  │                     │
│           │  4×4   │                     │
│           └────────┘                     │
│                                          │
├──────────────────────────────────────────┤
│ [농장] [정제소] [민가] [연립] [우물] [방앗간] │ ← 건설 메뉴
│ [전체수확]  [철거모드]  [취소]              │ ← 액션 버튼
└──────────────────────────────────────────┘
```

### 7.2 건물 선택 시 정보 표시

건설 메뉴에서 건물에 마우스를 올리면:

```
┌──────────────────┐
│ 농장              │
│ 크기: 2×2        │
│ 비용: 은화 500   │
│ 생산: 식량 60/h  │
│ 보유: 1/4        │
└──────────────────┘
```

### 7.3 건물 클릭 시 정보 패널

배치된 건물을 클릭하면:

```
┌──────────────────────┐
│ 농장 Lv.1            │
│ 생산: 42 식량/h      │
│ 저장: 120/500        │
│                      │
│ [수확] [레벨업 🪙1000] │
│ [철거 (환급 250)]     │
└──────────────────────┘
```

### 7.4 영주성 클릭 시 정보 패널

```
┌──────────────────────┐
│ 영주성 Lv.1          │
│ 세금 계수: 1.0       │
│ 누적 세금: 52 은화    │
│                      │
│ [세금 수령]           │
│ [레벨업 🪙1000]      │
│                      │
│ 다음 해금:           │
│  - 마력 정제소        │
│  - 연립 주택          │
└──────────────────────┘
```
